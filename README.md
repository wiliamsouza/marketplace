# Marketplace

This project is decomposed in two bounded contexts product and promotion.

## Architecture

Marketplace is composed of two microservices using Go and Python
that talk to each other over gRPC.

[![Architecture](./docs/img/architecture.png)](./docs/img/architecture.png)

| Service            | Language | Decription                                            |
| ------------------ | -------- | ----------------------------------------------------- |
| product            | Go       | Provides the list of products                         |
| promotion          | Python   | Discounts for products                                |
| load               | Python   | Continuously sends requests imitating realistic usage |
| API gateway        | Go       | gRPC to HTTP gateway generate from product protocol   |

## Get started

Clone the repository:

```
git clone https://github.com/wiliamsouza/maketplace.git
```

Get promotion and product repository:

```
git submodule --init
```

If you want update product and promotion code run:

```
git submodule update --remote
```

## Build docker images

```
docker-compose build
```

> :information_source: : **If you are having trouble to generate docker images**: You can point to images generate in docker hub!

Docker hub images:

* https://hub.docker.com/repository/docker/wiliamsouza/promotion
* https://hub.docker.com/repository/docker/wiliamsouza/product

Those images are even with branch `master` and auto generated by CI.

## Set up database:

Start postgresql:

```
docker-compose up database
```

This will create required database for services and tests.

Create promotion schema:

```
docker run --network marketplace_internal --env-file promotion/docker.env --entrypoint /usr/local/bin/promotionctl --rm marketplace_promotion database create schema
```

Create product schema:

Enter product directory:

```
cd product/
```

Create schemas:

```
make migrate
cd ..
```

Stop docker compose hiting CTRL-C.

## Usage

Start all servers and database:

```
docker-compose up
```

Frist set API endpoint: 

```
export API_ENDPOINT=http://api.d.wiliam.dev/v1beta1
```

Call product server HTTP REST server product endpoint.

```
curl -v $API_ENDPOINT/cataloging/products
```

An empty json object is returned no product exist on database. 

Create a product:

```
docker run --network marketplace_internal --entrypoint /usr/sbin/productctl --rm marketplace_product-grpc client --host product-grpc create product --title "Product title" --description "Product description" --price 10000
```

List created product:

```
curl -v $API_ENDPOINT/cataloging/products
```

Create a user:
```
docker run --network marketplace_internal --env-file promotion/docker.env --entrypoint /usr/local/bin/promotionctl --rm marketplace_promotion client create user --endpoint promotion:50051 --birthday `date --utc +%Y-%m-%d`
```

This created a user which birthday is today.

Set user identification as environment variable:

```
export USER_ID=
```

With the user created you can list products with discount for this user:

```
curl -v --header "X-USER-ID: $USER_ID" $API_ENDPOINT/cataloging/products
```

The product should include a discount of 5%.


To test the graceful degradation stop the promotion service.
Run the command inside marketplace directory:

```
docker-compose stop promotion
```

Repeat the commands to see how this keep working without discount.


The commands above are suppose to work on linux.

If you have some thoube use the follow changing `127.0.0.1` to external address of your docker.

```
curl --header "Host: api.d.wiliam.dev" http://127.0.0.1/v1beta1/cataloging/products
```

This way the edge router know how to properly redirect API call.
